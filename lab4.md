# Отчет по лабораторной работе №4

## Цель

Знакомство студентов с алгоритмами кэширования. В рамках данной работы необходимо разработать кэширующий SQL-proxy - программу, которая принимала бы запросы к БД, отправляла эти запросы в БД, сохраняла бы результаты в хранилище. Если приходит повторный запрос на чтение - выдавала запросы из хранилища, если приходит запрос на изменение - сбрасывала бы значения всех запросов, результаты которых станут неактуальными после внесенных изменений.

## Программа работы

1. Общее описание:
    * для данной работы необходимо выбрать часть таблиц БД (3+), для которой можно придумать/использовать осмысленные SQL-запросы, необходимые для выполнения пользовательских функций
    * в рамках работы необходимо реализовать две программы: кэширующий прокси и программа для выполнения запросов и измерения результатов

2. Выбор понравившегося способа кэширования:
    * в памяти программы
    * с использованием внешних хранилищ
    * во внешней памяти

3. Реализация выбранного способа:
    * преобразование входных запросов
    * выбор ключа для хранения результатов
    * реализация алгоритма поиска сохраненных результатов, которые надо сбросить после внесения изменений в БД

4. Снятие показательных характеристик:

    * в программе для формирования потока запросов к БД на чтение/изменение/удаление должна быть возможность настройки соотношения запросов, количества запросов разных типов в потоке и измерения временных характеристик: среднее/минимальное/максимальное время выполнения запроса по типу, необходимо иметь возможность проанализировать эффективность кэширования в различных сценариев: преимущественно чтение, преимущественно изменение, преимущественно удаление
    * измерения можно производить путем простого сравнения отметок текущего времени до и после выполнения запросов

5. Анализ полученных результатов и сравнение реализаций с кэшем и без между собой.

6. Демонстрация результатов преподавателю.

### Ход работы

1. Предварительные заметки
    * Я выбрал 3 таблицы - Stations, Routes, RouteSections.
    * ВАЖНО! Я починил генератор данных (иногда время отправления и прибытия совпадали, на что есть ограничение в схеме, поэтому бросалось исключение) - нужно сгенерировать новый jar (либо добавлять routes в небольшом количестве например ~100).
    * БД заполняется с параметрами -s (stations) равным 250 и -r (routes) равным 1000 (количество записей в route_sections пропорционально количеству записей routes, в среднем длина маршрута 5 участков - тогда всего там будет около 5000 записей).
    * Для взаимодействия с ДБ я выбрал <https://crates.io/crates/postgres>.
    * Прокси и клиент общаются через <https://doc.rust-lang.org/std/sync/mpsc/> из разных потоков.

2. Выбор способа кэширования:
    * Очевидно, что самый простой (и быстрый) способ реализовать кэш - в памяти программы.

3. Реализация выбранного способа:
    * В качестве ключей я выбрал сами запросы (без предварительной обработки). Но мне пришлось отдельно указывать, какие таблицы используется в запросе (или будут изменены) - [код с запросами](lab4/cacher/src/requests/mod.rs).
    * Реализация самого кэша лежит в [файле](lab4/cacher/src/handler/cache.rs). К нему написаны 2 теста - их можно запустить командой ```cargo test```. Кэш состоит из двух частей - собственно [LRU кэш](https://crates.io/crates/lru) и hashmap, в котором хранятся пары "имя таблицы"-"список запросов", он используется, чтобы удалять те элементы кэша, которые не отражают актуальную информацию после изменения. Когда мы объявляем таблицу недействительной мы удаляем все запросы в списке из кэша и сбрасываем список.

4. Снятие показательных характеристик:
    * Я решил объединить Delete и Update запросы, так как они похожи в том смысле, что сбрасывают кэш (если число измененных записей не равно нулю - это учитывается в моей реализации).
    * Запросы выбираются случайным образом (Select и Delete/Update выбираются отдельно, вероятность выбора между Select и Delete/Update можно задать параметром).
    * Измерения производятся путем простого сравнения отметок текущего времени до и после выполнения запросов.

5. Анализ полученных результатов и сравнение реализаций с кэшем и без между собой:

Выполняется 1000 запросов (всего), размер кэша - 16 записей, вероятность выполнения Select запроса вместо Delete/Update равна 95%. Результаты в [файле](lab4/results_cap16_n1000_sel95.txt).

Результаты с кэшем справа, без - слева.

```text
Delete unused stations: 
    min_time = 7.223569ms   6.915636ms
    max_time = 10.959277ms  10.035768ms
    avg_time = 8.058721ms   7.962702ms
Select all route sections:
    min_time = 9.962µs      6.619297ms    (в 1000 раз)
    max_time = 12.991033ms  14.406474ms
    avg_time = 739.28µs     7.302047ms    (минус 90%)
Select all routes:
    min_time = 6.49µs       811.576µs     (в 100 раз)
    max_time = 1.317188ms   2.544915ms
    avg_time = 58.986µs     1.117894ms    (минус 95%)
Select all stations:
    min_time = 5.485µs      374.522µs     (в 100 раз)
    max_time = 946.103µs    1.432213ms
    avg_time = 74.138µs     633.215µs     (минус 90%)
Select route sections with cost more than:
    min_time = 11.327µs     6.81879ms     (в 1000 раз)
    max_time = 10.606348ms  13.368669ms
    avg_time = 4.247634ms   7.480124ms    (минус 45%)
Select routes with latitude more than:
    min_time = 6.322µs      539.265µs     (в 100 раз)
    max_time = 1.898808ms   2.522779ms
    avg_time = 628.642µs    1.072273ms    (минус 40%)
Update route sections cost:
    min_time = 12.273394ms  12.176097ms
    max_time = 20.79101ms   20.387393ms
    avg_time = 14.278586ms  15.027237ms
Update stations location:
    min_time = 1.618693ms   1.760193ms
    max_time = 8.959176ms   8.945806ms
    avg_time = 3.764333ms   3.463981ms
```

Анализируя результаты можно сказать следующее:

* Для больших таблиц (route sections) прирост более существенный - минимальное время запроса - уменьшение до 1000 раз.
* Для запросов типа "select all ..." прирост более существенен - до минус 95% времени выполнения, в сравнении с запросами с аргументами (два последних "select"), где время выполнения уменьшилось в среднем в 2 раза (минус 40-45%).
* Время выполнения Delete/Update в среднем почти без изменений.
* Максимальное время ответа в среднем тоже уменьшилось.

Выполняется 5000 (вместо 1000) запросов (всего), размер кэша - 16 записей, вероятность выполнения Select запроса вместо Delete/Update равна 5%. Результаты в [файле](lab4/results_cap16_n5000_sel05.txt).

```text
Delete unused stations:
    min_time = 6.734699ms   6.801185ms
    max_time = 23.679938ms  16.974756ms
    avg_time = 8.460569ms   8.347365ms
Select all route sections:
    min_time = 6.781748ms   6.859805ms    (~)
    max_time = 15.62006ms   15.996128ms
    avg_time = 7.880279ms   8.208935ms    (~)
Select all routes:
    min_time = 15.125µs     888.867µs     (в 100 раз)
    max_time = 1.176979ms   1.267501ms
    avg_time = 112.892µs    1.048086ms    (минус 90%)
Select all stations:
    min_time = 96.661µs     485.753µs     (в 5 раз)
    max_time = 1.911705ms   1.801917ms
    avg_time = 667.858µs    675.037µs     (~)
Select route sections with cost more than:
    min_time = 6.872388ms   7.022211ms    (~)
    max_time = 9.672504ms   9.733927ms
    avg_time = 7.788376ms   7.97282ms     (~)
Select routes with latitude more than:
    min_time = 100.933µs    656.574µs     (в 6 раз)
    max_time = 2.901864ms   4.239212ms
    avg_time = 1.072019ms   1.152091ms    (~)
Update route sections cost:
    min_time = 11.566631ms  11.554784ms
    max_time = 45.741381ms  47.141173ms
    avg_time = 13.67337ms   13.51372ms
Update stations location:
    min_time = 1.521324ms   1.50455ms
    max_time = 28.568154ms  28.953246ms
    avg_time = 2.215173ms   2.145665ms
```

Анализируя результаты можно сказать следующее:

* Так как у меня нет запросов, которые бы изменяли таблицу routes, время выполнения запросов "Select all routes" с кэшом не изменилось и все еще меньше на 90% для среднего времени.

* В то же время друге запросы "select" все еще могут показать меньшее время с кэшем, но среднее время выполнения почти не отличатеся от запросов без кэша.

